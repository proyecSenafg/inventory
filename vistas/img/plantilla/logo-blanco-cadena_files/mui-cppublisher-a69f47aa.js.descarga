(window.webpackJsonp=window.webpackJsonp||[]).push([["mui-cppublisher"],{2037:function(e,t,i){var s,r;s=[i(16),i(9),i(11),i(2),i(13),i(33),i(6),i(63),i(1),i(103),i(111),i(170)],void 0===(r=function(e,t,i,s,r,n,o,a,u,c,l,p){"use strict";var h,d=new o.default({color:"orange",name:"publisher"});return i.Model.extend({initialize:function(e){h=e.cpUtils,this.confirmView=c,this._hasUploadedResource=!1},getPublishedLink:function(e){var t="",i=e.getMyApp(),s=i.getPublishImpl();switch(i.registeredName){case"ginger-snap":t=s.getData("publishedVideoURL",e);break;default:t=h.cpLink(i.getCPCommunity(),i.getCPAssetId(e),i.getCPAlias(e))}return t},getCommunityCategories:function(e,t){return h.getCommunityCategories(e,t)},getVersion:function(e,i){var n=s.defer();return i=i?i+"/":"",r.ajax({type:"GET",url:"https://"+h.cpService+"/api/v2/resources/"+e+"/"+i+":metadata",headers:{Accept:"*/*","X-api-key":h.apiKey}}).then((function(e,i,s){t.isUndefined(e.version)?n.resolve(new Date(e.modified)-new Date(e.created)):n.resolve(e.version)}),(function(e){n.reject(e)})),n.promise},initiateServerCopy:function(e,i,n,o){var a=u.maxFilesInCpCopy;if(n.cleanUpComponentsBeforeServerCopy&&"function"==typeof n.cleanUpComponentsBeforeServerCopy&&n.cleanUpComponentsBeforeServerCopy(e,i,o),e.copy.files.length<=a){var c=s.defer();return r.ajax({type:"POST",url:"https://"+h.cpService+"/api/v2/resources/"+this.getResourcePath(i)+"/:copy?api_key="+h.apiKey,data:JSON.stringify(e),headers:{Accept:"*/*","Content-Type":"application/json"},success:function(e,t,i){var s=i.getResponseHeader("Location");c.resolve(s+"?api_key="+h.apiKey)}.bind(this),error:function(e){d.error("Server-side initiate copy failed with "+e.status,e),c.reject(e)}}),c.promise}var l=t.chunk(e.copy.files,a),p=t.clone(e),f=[],b=e.copy.files.length;return delete p.copy.files,t.each(l,function(e){var n=s.defer(),o=e.length,a=t.clone(p);f.push(n.promise),a.copy.files=e,r.ajax({type:"POST",url:"https://"+h.cpService+"/api/v2/resources/"+this.getResourcePath(i)+"/:copy?api_key="+h.apiKey,data:JSON.stringify(a),headers:{Accept:"*/*","Content-Type":"application/json"},success:function(e,t,i){var s=i.getResponseHeader("Location");n.resolve({weight:o/b,url:s+"?api_key="+h.apiKey})}.bind(this),error:function(e){d.error("Server-side initiate chunk copy failed with "+e.status,e),n.reject(e)}})}.bind(this)),s.all(f).then((function(e){return e})).catch((function(e){return s.reject(e)}))},updateOneProgress:function(e,i,s,r){var n=0;if("object"==typeof i){if(i.monitors[s].pct=r.progress,t.each(i.monitors,(function(e){n+=e.pct*e.weight})),i.lastSentPct===n)return;i.lastSentPct=n}else n=r.progress;e.trigger("progress",n)},_getCheckStatusError:function(e,t,i){var s="Server-side copy monitor status error:";s+=i?i.error_code+":"+i.sub_error_code+":"+i.error_message:e.status;var r=new Error(s);return r.url=t,r.responseText=e.responseText,r.is_resources_copy_err=!0,i?(r.status=i.error_code,r.sub_error_code=i.sub_error_code):r.status=e.status,d.error(r.message,r),r},checkStatus:function(e,i,n,o,a){var u=i||s.defer();if(r.ajax({type:"GET",url:e,headers:{Accept:"*/*"},success:function(i,s,r){"done"==i.status?(n.trigger&&o&&this.updateOneProgress(n,o,e,i),u.resolve(i)):"in_progress"==i.status?(n.trigger&&o&&this.updateOneProgress(n,o,e,i),t.delay(this.checkStatus.bind(this,e,u,n,o,a),a||500)):"failed"==i.status?u.reject(this._getCheckStatusError(r,e,i)):t.delay(this.checkStatus.bind(this,e,u,n,o,a),a||500)}.bind(this),error:function(t){u.reject(this._getCheckStatusError(t,e))}}),!i)return u.promise},getManifest:function(e,t,i){var s={title:"string"==typeof t.title?t.title:e.get("name"),undiscoverable:!t.isPublic,description:t.description||"",category_id:t.category,sub_category_ids:[t.subcat||"other"]};return i?s:{resource_path:t.projectId,resource_type:t.type,metadata:s}},getHasUploadedResource:function(){return this._hasUploadedResource},setHasUploadedResource:function(e){this._hasUploadedResource=e},createDirectoryResource:function(t,i,n){return s.Promise(function(s,o){var a="";"adobe-theo"===t.get("syncGroupName")&&(a="?"+e.param({tags:"collection_class:dcx_composite"})),r.ajax({type:"PUT",url:"https://"+h.cpService+"/api/v2/resources/"+this.getResourcePath(i,n)+"/:dir"+a,headers:{Accept:"application/json","X-Api-Key":h.apiKey},success:function(e){s(e)},error:function(e){d.error("Failed to create resource directory with "+e.status,{xhr:e,projectId:i,path:n}),o(e)}.bind(this)})}.bind(this))},uploadResources:function(e,i,r,n){if("function"!=typeof n){var o=[];return t.each(r,function(t,s){o.push(this.uploadResource(e,i,s,t))}.bind(this)),s.all(o)}var a,u=function(t,o){return this.uploadResource(e,i,t,o).then((function(e){return s(n(r,t,e)).then((function(){return e}))}))}.bind(this),c=[];return t.each(r,(function(e,t){"manifest"===t?a=e:c.push(u(t,e))})),s.all(c).then((function(e){return a?u("manifest",a).then((function(t){return e.push(t),e})):e}))},uploadResource:function(e,t,i,n,o){var a=s.defer();return this._hasUploadedResource=!1,this.checkResource(e,t,i,n).then(function(s){var u="update"===s,c="text/html",l=n;"object"==typeof n&&n.content&&(c=n.contentType,l=n.content),r.ajax({type:"PUT",url:"https://"+h.cpService+"/api/v2/resources/"+this.getResourcePath(t,i),headers:{Accept:"application/vnd.adobe.file+json","X-Api-Key":h.apiKey,"Content-Type":c},beforeSend:function(e){u&&e.setRequestHeader("If-Match","*")},data:l,processData:!(l instanceof Uint8Array||l instanceof ArrayBuffer),success:function(e){this._hasUploadedResource=!0,a.resolve(e)}.bind(this),error:function(s){409!==s.status||u||o?(d.error("Failed to upload resource with "+s.status,{xhr:s,projectId:t,path:i}),a.reject(s)):this.uploadResource(e,t,i,n,!0).then((function(e){a.resolve(e)}),(function(e){a.reject(e)}))}.bind(this)})}.bind(this)),a.promise},checkResource:function(e,t,i,n){var o=s.defer();return r.ajax({type:"GET",url:"https://"+h.cpService+"/api/v2/resources/"+this.getResourcePath(t,i)+"/:S3",headers:{Accept:"*/*","X-Api-Key":h.apiKey},success:function(){d.debug("Resource exists, update",{projectId:t,path:i}),o.resolve("update")},error:function(){d.debug("Resource doesn't exist, upload",{projectId:t,path:i}),o.resolve("upload")}}),o.promise},getResourcePath:function(e,t){return e+(t?"/"+t:"")},_fetchAssetMetadata:function(e,i){var n,o=s.defer(),a=this,u=!1;return d.debug("fetch asset meta-data for "+i),n=function(s,c,l){c||(c=new Date),l||(l=500),r.ajax({type:"GET",url:"https://"+h.cpService+"/api/v2/"+e+"/assets/"+i,dataType:"json",headers:{"X-Api-Key":h.apiKey,Accept:"application/hal+json"},success:function(e){a.hideConfirm(),d.debug("fetched asset meta-data for "+i,e),o.resolve(e)},error:function(e){if(500!==e.status&&404!==e.status)a.hideConfirm(),d.error("Failed to fetch recently published asset from CP",{assetId:i,err:e}),o.reject(e);else{var r,p=(new Date).getTime(),h=p-c.getTime();if(u)d.error("Failed to fetch recently published asset from CP after waiting",{assetId:i,err:e,waitSecs:h/1e3}),e.shownErr=!0,o.reject(e),o=null;else{if(h>6e4)return void a.showConfirm("Publishing has reached the maximum time that it can wait","Please try again later.",!0,null,function(){d.error("Failed to fetch recently published asset from CP after waiting max time",{assetId:i,err:e}),e.shownErr=!0,o.reject(e),o=null}.bind(this));this.confirmView.isShowing()||(s?r=p-s.getTime():s=new Date,r>=1e4?(s=null,a.showConfirm("Publishing is taking longer than usual.","Would you like to cancel and try again later, or would you like to wait a little longer?",!1,"Continue",function(e){e||(u=!0)}.bind(this))):h>3e3&&(l=1e3))}o&&t.delay((function(){n(s,c,l)}),l)}}})}.bind(this),t.defer(n),o.promise},showConfirm:function(e,t,i,s,r){i?this.confirmView.showAlert(e,t,{okText:s}).then((function(e){r(e)})):this.confirmView.showConfirm(e,t,{okText:s}).then((function(e){r(e)}))},hideConfirm:function(){this.confirmView.isShowing()&&this.confirmView.hide()},updatePublishedAsset:function(e,t,i){var n,o=this,a=s.defer();return e.mrvlDoc?(t=e.pubSettings,i=e.cpAssetId,n=this.addMetaDataToPubInfo(e,!0)):n=this.getManifest(e,t,!0),r.ajax({type:"PUT",url:"https://"+h.cpService+"/api/v2/"+t.community+"/assets/"+i,headers:{"X-Api-Key":h.apiKey,Accept:"application/vnd.adobe.file+json","Content-Type":"application/json"},data:JSON.stringify(n,null,"  "),success:function(e,s,r){o._fetchAssetMetadata(t.community,i).then((function(e){a.resolve(e)}),(function(e){a.reject(e)}))},error:function(e){d.error("Failed to update asset in CP "+e.status,e),a.reject(e)}}),a.promise},acquireShareLinkFromPubInfo:function(e){var t=e.publishConfig;return t.category||((t=this.getCopyOfPubConfigFromPubInfo(e)).category="other"),e.publishImpl.acquireShareLink(e.mrvlDoc,e.publishImpl,t,e.progressId).then(function(t){return t&&(t.cancel||(e.cpAssetId=t.asset.assetId,t.cpAlias=t.asset.cpAlias,t.asset&&t.asset.resource_version&&(e.lastUpdatedMainResourceVersion=t.asset.resource_version))),{publishData:t,pubInfo:e}}.bind(this))},acquireFinalDownloadLink:function(e,t,i){if(i.cancel)return{publishData:i,pubInfo:e};var n=s.defer();return t=t.replace(/"/g,"'"),r.ajax({type:"GET",url:i.link+"/:raw",headers:{Accept:"application/vnd.adobe.s3presignedurl+json","X-api-key":h.apiKey,"Content-Disposition":'attachment; filename="'+encodeURI(t)+'"'},success:function(e){n.resolve(e)},error:function(e){d.error("getPresignedUrlDefer: "+e.status,e),n.reject(e)}}),n.promise.then(function(t){return i.downloadLink=t.presigned_href,{publishData:i,pubInfo:e}}.bind(this))},acquireDownloadLinkFromPubInfo:function(e,t){return e.publishImpl.downloadFile(e.mrvlDoc,e.publishImpl,e.publishConfig,e.progressId).then(function(i){return this.acquireFinalDownloadLink(e,t,i)}.bind(this))},_getPreShareCpAlias:function(e){if(!e.aquireAliasBeforePublish)return s.resolve(e);var t=s.defer();return r.ajax({type:"POST",url:"https://"+h.cpService+"/api/v2/"+e.app.getCPCommunity()+"/alias",headers:{Accept:"*/*","X-api-key":h.apiKey},success:function(e){t.resolve(e)},error:function(e){d.error("_getPreShareCpAlias data error: "+e.status,e),t.reject(e)}}),t.promise.then(function(t){return e.cpAlias=t.alias,e}.bind(this))},calculatePreshare:function(e,t){var i=s.defer(),r={pubInfo:e,mrvlDoc:e.mrvlDoc,fileDataIsOnlyForAvatar:!1,avatarNeedsUpload:!1},n=e.supportsFileData&&!e.filesDataResult&&!e.isRepublishWithIdenticalContent,o=e.prepublishFunction&&!e.prePubResult&&!e.isRepublishWithIdenticalContent;return e.publishImpl.finalizePublish&&(e.finalizerPublishPromise=null),e.publishConfig.showAvatar&&this.getAvatarComponent(e.mrvlDoc,e.app.getStorageImpl())&&e.supportsFileData&&!n&&(r.fileDataIsOnlyForAvatar=!0,e.lastAvatarCopied?e.avatarDirty&&e.avatarDirty!==e.lastAvatarSuccessfullyCopiedDirty&&(r.avatarNeedsUpload=!0):r.avatarNeedsUpload=!0,r.avatarNeedsUpload&&(n=!0)),o?e.prepublishFunction().then(function(s){t(e)&&i.resolve("cancel"),e.prePubResult=s,n?this.fetchCurrentDocFilesData(r,t).then((function(e){i.resolve(e)})).catch((function(e){d.error("fetchCurrentDocFilesData failed on pre-publish step on calculatePreshare",{error:e,result:s}),i.resolve("skipped")})).done():i.resolve("skipped")}.bind(this)):n?this.fetchCurrentDocFilesData(r,t).then((function(e){i.resolve(e)})).catch((function(e){d.error("fetchCurrentDocFilesData failed on calculatePreshare when file data was needed",{error:e}),i.resolve("skipped")})).done():i.resolve("skipped"),i.promise.then(function(t){return"cancel"===t?s.resolve(e,"cancel"):"skipped"===t?(e.filesDataResult&&(e.filesDataResult.avatarNeedsUpload=r.avatarNeedsUpload,e.filesDataResult.fileDataIsOnlyForAvatar=r.fileDataIsOnlyForAvatar),s.resolve(e,"success")):(e.filesDataResult=t,e.publishConfig.showAvatar&&this.addAvatarSrcToFilesDataResult(e),s.resolve(e,"success"))}.bind(this))},_addLinkToPreshareRslt:function(e,t){return e.link||!e.aquireAliasBeforePublish&&!t||(e.cpAlias?e.link=h.cpLink(e.pubSettings.community,null,e.cpAlias):(t||d.error("no cpAlias for preshare!",e),e.link="")),e},setPotentialPublishedStateOfPubInfo:function(e){e.app.getCPAlias(e.mrvlDoc);var t=e.app.getCPAssetId(e.mrvlDoc);return e.potentialPubState=!!t,e.potentialDirtyPublish=e.app.hasContentBeenUpdatedSincePublish(e.mrvlDoc),e.potentialPubState},acquirePreshareLink:function(e){if(this.setIsPublishing(!0,e.publishImpl),e.initialConfigSettings=this.getCopyOfPubConfigFromPubInfo(e),e.settingsRequireDocRecalc=!1,e.publishImpl.acquirePreshareLink)return e.publishImpl.acquirePreshareLink.apply(e.publishImpl,[e.mrvlDoc,e.publishImpl,e.publishConfig]);var t=s.defer(),i=e.app.getCPAssetId(e.mrvlDoc);return e.projectId=e.app.getCPProjectId(e.mrvlDoc),e.cpAssetId=i,e.cpAlias=e.app.getCPAlias(e.mrvlDoc),e.isRepublish=!!i,e.pubSettings={type:e.assetType,community:e.app.getCPCommunity(),category:e.publishImpl.communityCategory,subcat:e.publishConfig.category,isPublic:e.publishConfig.isPublic},e.cpVerifyChange=!1,e.pubSettings.projectId=e.projectId,e.projectId?h.checkPublishState(e.projectId).then(function(s,r,n){var o=s.id;0===o.indexOf("US/")&&(o=o.substr(3)),e.cpAssetId!==o?(e.cpVerifyChange=!0,h.checkUnpublishedState(o,e.app.getCPCommunity()).then(function(s,r,n){d.warn("Discovered inaccurate CP asset ID was "+i+" now "+o),e.cpAssetId=o,e.isRepublish=!0,s.alias?(e.cpAlias=s.alias,t.resolve(this._addLinkToPreshareRslt(e,!0))):(d.error("checkUnpublishedState had inaccurate CP asset ID, but no alias",s),this._getPreShareCpAlias(e).done(function(){t.resolve(this._addLinkToPreshareRslt(e,!0))}.bind(this)))}.bind(this),function(i){this._getPreShareCpAlias(e).done(function(){t.resolve(this._addLinkToPreshareRslt(e,!0))}.bind(this))}.bind(this))):(e.app.hasContentBeenUpdatedSincePublish(e.mrvlDoc)||(e.isRepublishWithIdenticalContent=!0),t.resolve(this._addLinkToPreshareRslt(e)))}.bind(this),function(r){var n=s();e.isRepublish&&(d.warn("Discovered inaccurate CP asset ID was "+i+" but it wasn't published"),e.isRepublish=!1,e.cpAssetId=null,n=this.createDirectoryResource(e.mrvlDoc,e.projectId)),n.then(this._getPreShareCpAlias.bind(this,e)).done(function(){t.resolve(this._addLinkToPreshareRslt(e))}.bind(this))}.bind(this)):(e.projectId=e.app.generateCPProjectId(e.mrvlDoc),e.app.setCPProjectId(e.mrvlDoc,e.projectId),e.pubSettings.projectId=e.projectId,this.createDirectoryResource(e.mrvlDoc,e.projectId).then(this._getPreShareCpAlias.bind(this,e)).done(function(){t.resolve(this._addLinkToPreshareRslt(e))}.bind(this))),t.promise},addAvatarSrcToFilesDataResult:function(e){var i=t.find(e.filesDataResult.currentFilesInfo.copy,(function(e){return e.destination.match(/^avatar/)}));return t.isUndefined(i)||(e.filesDataResult.currentFilesInfo.avatarFile={copyInfo:i}),!!e.filesDataResult.currentFilesInfo.avatarFile},getAvatarComponent:function(e,t){var i=e.getDCXComposite().current;if(t.avatarComponentPath)return i.getComponentWithAbsolutePath(t.avatarComponentPath);var s=i.getComponentWithAbsolutePath("/avatar.jpg");return s||(s=i.getComponentWithAbsolutePath("/avatar.png")),s},getCopyOfPubConfigFromPubInfo:function(e,i){return t.clone(i||e.publishConfig)},calculatePublishDataFromDoc:function(e){return e.publishImpl.finalizePublish?(e.publishResources="finalize",s.resolve(e)):(e.forceDocRecalcForThisShare?(t=!0,e.forceDocRecalcForThisShare=!1):t=!e.isRepublish||e.app.hasContentBeenUpdatedSincePublish(e.mrvlDoc)||this.doShareSettingsRequireContentRecalc(e),this.cachePublishingEtag(e),t?this.calculatePublishResources(e):(e.isRepublish||d.error("doc doesn't need recalc for initial publish",e),e.settingsFromLastResourcesCalc=this.getCopyOfPubConfigFromPubInfo(e),e.publishResources="current",s.resolve(e)));var t},publishSettingsChanged:function(e,t){return this.recalcSettingsChanged(e)},recalcSettingsChanged:function(e){var i=e.settingsRequireDocRecalc,s=e.settingsFromLastResourcesCalc||e.initialConfigSettings,r=e.publishConfig;return e.lastPublishAssetInfo&&(s=e.lastPublishAssetInfo.pubConfig),e.settingsChangedSinceLastShare=t.find(s,(function(e,t){return r[t]!==s[t]})),e.settingsRequireDocRecalc=this.doShareSettingsRequireContentRecalc(e),e.settingsRequireDocRecalc?e.settingsDirty=!0:e.settingsDirty=t.some(e.fields.metadataOnly,(function(e){return r[e]!==s[e]})),e.settingsRequireDocRecalc!==i&&d.debug("Share settings require recalc changed to:"+e.settingsRequireDocRecalc),e.settingsDirty},doShareSettingsRequireContentRecalc:function(e){if(e.publishImpl.finalizePublish)return!1;var i=e.settingsFromLastResourcesCalc||e.initialConfigSettings,s=e.publishConfig,r=!1;return e.fields.doesAuthorChangeRequireDocRecalc&&(s[e.fields.showAuthorFieldId]!==i[e.fields.showAuthorFieldId]?r=!0:s[e.fields.showAuthorFieldId]&&(r=t.some(e.fields.author,(function(e){return s[e]!==i[e]}))),!r&&e.fields.showAvatarFieldId&&(r=!0===s[e.fields.showAvatarFieldId]?!i[e.fields.showAvatarFieldId]||s[e.fields.avatarUrlFieldId]!==i[e.fields.avatarUrlFieldId]:i[e.fields.showAvatarFieldId]&&i[e.fields.avatarUrlFieldId])),!r&&e.fields.nonAuthorFieldsThatTriggerContentRecalc&&(r=t.some(e.fields.nonAuthorFieldsThatTriggerContentRecalc,(function(e){return s[e]!==i[e]}))),r},cachePublishingEtag:function(e){e.publishingEtag=e.mrvlDoc.getMainContentEtag()},calculatePublishResources:function(e){var t,i=s.defer(),r={etag:e.publishingEtag};t={id:e.cpAssetId,alias:e.cpAlias,_links:{self:{href:this.getHrefForPublishedAsset(e.cpAssetId,e.pubSettings)}},publish_url:e.link},e.settingsFromLastResourcesCalc=this.getCopyOfPubConfigFromPubInfo(e);var n=e.publishConfig;return(e.publishImpl.getUpdatedPublishResourcesForPublishConfig&&e.isRepublishWithIdenticalContent&&e.publishResources&&e.publishResources.resources?e.publishImpl.getUpdatedPublishResourcesForPublishConfig(e.mrvlDoc,e.publishResources.resources,n):e.publishImpl.doPublish(e.mrvlDoc,n,t)).done(function(t){r.resources=t,e.publishResources=r,i.resolve(e)}.bind(this)),i.promise},getCPAssetIdFromAssetUrl:function(e){var t=e.split("/");return t[t.length-1]},finalizeServerPublish:function(e){if(e.finalizerPublishPromise)return e.finalizerPublishPromise;this.recalcSettingsChanged(e),e.settingsFromLastResourcesCalc=this.getCopyOfPubConfigFromPubInfo(e);var i=e.publishConfig,s={};return i!==e.publishConfig&&(i=t.clone(e.publishConfig)),i.cpAssetId=e.cpAssetId,i.cpAlias=e.cpAlias,i.cpResourceId=e.projectId,s.previousPublishConfig=e.lastFinalizeServerPublishConfig||e.initialConfigSettings,s.isRepublish=e.isRepublish,s.contentDirty=!s.isRepublish||!e.isRepublishWithIdenticalContent,s.settingsDirty=e.settingsDirty,e.lastFinalizeServerPublishConfig=this.getCopyOfPubConfigFromPubInfo(e,i),e.finalizerPublishPromise=e.publishImpl.finalizePublish(e.mrvlDoc,i,s).then(function(t){return t.alias&&(t.location&&(e.cpAssetId=this.getCPAssetIdFromAssetUrl(t.location),i.cpAssetId=e.cpAssetId),t.version&&(e.publishedAssetVersion=t.version),e.cpAlias!==t.alias?(e.cpAlias=t.alias,e.link=h.cpLink(e.pubSettings.community,null,e.cpAlias)):e.link||(e.link=h.cpLink(e.pubSettings.community,null,e.cpAlias))),e}.bind(this)),e.finalizerPublishPromise},_getcompositeFileDataFromStorage:function(e){var t=s.defer();return e||t.reject(),-1===e.search(/^https?\:\/\//)&&(e="https://"+e),r.ajax({type:"GET",url:e,dataType:"json",headers:{Accept:"*/*","X-api-key":h.apiKey},success:function(e){d.debug("Fetch data success",e),t.resolve(e)},error:function(e){d.error("Fetch data error: "+e.status,e),t.reject(e)}}),t.promise},fetchCurrentDocFilesData:function(e,i){var r=s.defer(),n=(s.defer(),e.mrvlDoc.getDCXComposite()),o=n.current,u=e.mrvlDoc.get("syncGroupName"),c=e.pubInfo,l=n.href;if(!l)try{l=a.dcxSession.getHrefForComposite(n,u)}catch(p){d.error("exception occurred while attempting to get href from composite",p),r.reject(p)}return this._getcompositeFileDataFromStorage(l).then(function(n){var a=[];if(i(c))return s.resolve("cancel");if(d.debug("fetchCurrentDocFilesData in progress",n),e.collectionId=n.id,c.publishImpl.getFilesDataToCopyFromServerData)return c.publishImpl.getFilesDataToCopyFromServerData(n,c.mrvlDoc,c.publishConfig).then((function(t){if(i(c))return s.resolve("cancel");e.currentFilesInfo={copy:t.files||t,data:n},e.additionalCopyDefer=t.additionalCopyDefer,r.resolve(e)}));var u=o.getComponentsOf();t.each(u,function(t){a.push({source:e.collectionId+"/"+t.id,content_type:t.type,destination:t.path})}.bind(this));var l=t.find(o.getChildrenOf(),(function(e){return"page"==e.name})),p=o.getComponentsOf(l);if(t.each(p,function(t){a.push({source:e.collectionId+"/"+t.id,destination:t.path,content_type:t.type})}.bind(this)),i(c))return s.resolve("cancel");e.currentFilesInfo={copy:a,data:n},r.resolve(e)}.bind(this)).catch((function(e){r.reject(e)})),r.promise},updateFileVersionsAfterCopy:function(e,i){if(i&&i.outputs)return t.each(e.filesDataResult.currentFilesInfo.copy,(function(e){if(e.track_version){var s=t.find(i.outputs,(function(t){return t.path===e.destination}));s&&(e.version=s.version,e.copyResults=s)}})),s.resolve();var r=[];if(t.each(e.filesDataResult.currentFilesInfo.copy,function(i){if(i.track_version&&t.isUndefined(i.version)){var n=s.defer();r.push(n.promise),this.getVersion(e.projectId,i.destination).then((function(e){i.version=e,n.resolve()}),(function(e){n.reject(e)}))}}.bind(this)),r.length){var n=s.defer();return s.allSettled(r).done((function(i){var s=[];t.each(i,(function(e){"fulfilled"!==e.state&&s.push(e.reason)})),s.length?n.reject(s):n.resolve(e)})),n.promise}return s.resolve()},copyThePublishDataFiles:function(e,i){if(e.publishImpl.copyThePublishDataFiles)return e.publishImpl.copyThePublishDataFiles(e,i);if(!e.filesDataResult)return s.resolve(e);var r,n=s.defer(),o=s.defer(),a=e.avatarDirty,u=e.filesDataResult.currentFilesInfo.avatarFile&&e.filesDataResult.currentFilesInfo.avatarFile.copyInfo;if(e.filesDataResult.fileDataIsOnlyForAvatar)e.filesDataResult.avatarNeedsUpload?u?r=[u]:(r=null,d.warn("avatarNeedsUpload but no src",e)):u=null;else if(e.filesDataResult.currentFilesInfo.copy.length&&(e.filesSuccessfullyCopied?(r=[],t.each(e.filesDataResult.currentFilesInfo.copy,(function(i){t.isUndefined(e.filesSuccessfullyCopied[i.source])&&r.push(i)}))):r=e.filesDataResult.currentFilesInfo.copy.slice(),e.initialCopyRequest&&!e.initialCopyRequest.done)){var c=[],l={};t.each(e.initialCopyRequest.copy.files,(function(e){l[e.source]=e})),t.each(r,(function(e){t.isUndefined(l[e.source])&&c.push(e)})),r=c}if(r&&r.length){u&&(e.lastAvatarCopied=u);var p,h={copy:{files:r}},f=!e.filesDataResult.fileDataIsOnlyForAvatar;d.debug("has files to copy server-side",r),e.filesDataResult.currentFilesInfo.status="initiating",e.initialCopyRequest||(e.initialCopyRequest=h,p=!0),this.initiateServerCopy(h,e.projectId,e.publishImpl,e.mrvlDoc).done(function(r){if(i(e))return o.resolve({status:"cancel"});if(t.isArray(r)){var n=[];h.copy.files.length;f&&(f={monitors:{},totalMonitors:0}),d.debug("Server side copy monitor URLs: "+r),e.filesDataResult.currentFilesInfo.status="monitoring",t.each(r,function(t){f&&(f.monitors[t.url]={pct:0,weight:t.weight},f.totalMonitors++),n.push(this.checkStatus(t.url,null,e.publishImpl,f,2e3))}.bind(this)),s.all(n).then((function(e){var i=[],s=t.find(e,(function(e){if("done"!==e.status)return!0;i=i.concat(e.outputs)}));s?o.resolve(s):(e[0].outputs=i,o.resolve(e[0]))})).catch((function(e){return o.reject(e)}))}else d.debug("Server side copy monitor URL: "+r),e.filesDataResult.currentFilesInfo.status="monitoring",this.checkStatus(r,null,e.publishImpl,f,500).done(function(e){o.resolve(e)}.bind(this),(function(e){o.reject(e)}))}.bind(this),function(e){o.reject(e)}.bind(this))}else o.resolve({status:"skipped"});return o.promise.then(function(o){var u=!1;"cancel"===o.status||i(e)?(u=!0,e.filesDataResult.currentFilesInfo.status="cancelled"):(p&&(e.initialCopyRequest.isDone=!0),e.filesDataResult.currentFilesInfo.status="done","done"===o.status&&(e.filesSuccessfullyCopied||(e.filesSuccessfullyCopied={}),t.each(r,(function(t){e.filesSuccessfullyCopied[t.source]=t})),a&&(e.lastAvatarSuccessfullyCopiedDirty=a))),(e.filesDataResult.additionalCopyDefer&&!u?e.filesDataResult.additionalCopyDefer.promise:s()).then(function(){e.publishImpl.reviseDoPublishAfterFilesUpdate?this.updateFileVersionsAfterCopy(e,o).then((function(){n.resolve(e)}),(function(e){n.reject(e)})):n.resolve(e)}.bind(this),(function(e){n.reject(e)}))}.bind(this),function(t){p&&delete e.initialCopyRequest,n.reject(t)}.bind(this)),n.promise},uploadThePublishResources:function(e){if(e.publishImpl.finalizePublish)return this.finalizeServerPublish(e);if("current"!==e.publishResources){var t=s.defer();return this.uploadResources(e.mrvlDoc,e.projectId,e.publishResources.resources,e.publishImpl.resourceUploadReport).done(function(i){e.publishResources.results=i,t.resolve()}.bind(this),(function(e){t.reject(e)})),t.promise}s.resolve()},doShareUploads:function(e,i){var r=s.defer(),n=(e.mrvlDoc.getDCXComposite().current,[]),o=!1;if(n.push(this.copyThePublishDataFiles(e,i)),!e.publishImpl.finalizePublish||e.userWantsToGoInfo&&(e.requiredFilled||e.isRepublish))if(e.publishImpl.reviseDoPublishAfterFilesUpdate&&e.publishResources&&e.publishResources.resources){var a=s.defer(),u=n[0];n.push(a.promise),u.then(function(t){e.publishImpl.reviseDoPublishAfterFilesUpdate(e.publishResources.resources,e.filesDataResult.currentFilesInfo.copy).then(function(t){this.uploadThePublishResources(e).then((function(){a.resolve()}),(function(e){a.reject(e)}))}.bind(this))}.bind(this),function(e){o=!0,d.error("could not upload due to copy error in doShareUploads",e),a.reject(e)}.bind(this))}else n.push(this.uploadThePublishResources(e));return s.allSettled(n).done(function(s){var n=[];(o&&s.shift(),t.each(s,(function(e){"fulfilled"!==e.state&&n.push(e.reason)})),n.length)?r.reject(n):"cancel"===s[0].value||i(e)?r.resolve("cancel"):r.resolve(s)}.bind(this)),r.promise},addPubInfoToCurrentDoc:function(e){if(e.publishImpl.savePublishedDataToDoc){var t={cpAlias:e.cpAlias,cpAssetId:e.cpAssetId,assetLink:this.getHrefForPublishedAsset(e.cpAssetId,e.pubSettings),publishUrl:e.link,publishedAssetVersion:e.publishedAssetVersion,contentEtag:e.publishingEtag,scope:e.pubSettings.isPublic?"public":"private"};e.publishImpl.savePublishedDataToDoc(e.mrvlDoc,t)}},saveSuccessfulPublishDataToDoc:function(e){e.app.setCPAssetId(e.mrvlDoc,e.cpAssetId),e.app.setCPAlias(e.mrvlDoc,e.cpAlias),"current"!==e.publishResources?e.app.setPublishedContentETag(e.mrvlDoc,e.publishResources.etag):e.app.getPublishedContentETag(e.mrvlDoc)||e.app.setPublishedContentETag(e.mrvlDoc),this.addPubInfoToCurrentDoc(e)},doWeNeedToPostThisPublishedAsset:function(e){return!0},setIsPublishing:function(e,t){t.setIsPublishing&&t.setIsPublishing(e),this.isPublishing=e},postTheAssetAtEndOfShare:function(e){var t,i=s.defer();if(this.doWeNeedToPostThisPublishedAsset(e))"string"==typeof e.publishConfig.publishTitle?e.pubSettings.title=e.publishConfig.publishTitle:e.pubSettings.title=e.mrvlDoc.get("name")||"",e.pubSettings.isPublic=e.publishConfig.isPublic,e.publishImpl.finalizePublish?(d.debug("publishing to slate server",e),t=this.finalizeServerPublish(e)):e.isRepublish?(d.debug("Republishing: "+e.cpAssetId),t=this.updatePublishedAsset(e)):e.lastPublishAssetInfo&&!e.lastPublishAssetInfo.promise.isRejected()?(d.warn("Publishing actual conent for first time, but updating:"+e.cpAssetId,e),t=this.updatePublishedAsset(e)):(d.debug("Publishing actual content for first time:"+e.cpAssetId),t=this.publishActualAsset(e));else{var r=s.defer();t=r.promise,r.resolve("success")}return e.postAssetPromise=t,t.then(function(t){var r=s.defer();e.lastUpdatedMainResourceVersion?r.resolve(e.lastUpdatedMainResourceVersion):e.mainResourceName?this.getVersion(e.projectId,e.mainResourceName).done(function(e){r.resolve(e)}.bind(this),function(e){i.reject(e)}.bind(this)):r.resolve(""),r.promise.then(function(t){this.setIsPublishing(!1,e.publishImpl),e.publishedAssetVersion=t,this.saveSuccessfulPublishDataToDoc(e),i.resolve("success")}.bind(this))}.bind(this),function(t){this.setIsPublishing(!1,e.publishImpl),i.reject(t)}.bind(this)),i.promise},publishBrandedChrome:function(e){var t,i=e.mrvlDoc;e.publishImpl.community,u.brandedChromeCommunity;return l.getController().then(function(e){return e.getActiveContext(i)}.bind(this)).then(function(e){var i;if(t=e,!e)throw(i=new Error("No active brand kit selected. Skipping branded chrome publish")).code="skip_branded_chrome_publish",i;if(!t.activated())throw(i=new Error("The active brand kit is not activated/complete yet. Skipping branded chrome publish")).code="skip_branded_chrome_publish",i;return t.changesSinceLastPublish()}.bind(this)).then(function(e){return e.changes?t.publish(e.assetId):(console.log("Local brand kit chrome checksum and remote checksum matched. skipping brand kit chrome publish"),e)}.bind(this)).then(function(e){return e.brandKit=t,e}.bind(this))},updateBrandedChromeMetadata:function(e,i){var r=e.mrvlDoc,n=i.brandKit;delete i.brandKit;var o=e.publishImpl.community,a=u.brandedChromeCommunity,c=n.getClientCommunityPlatform(),p=c(o),h=c(a),f={checksum:i.checksum};return f[e.cpAssetId]=i.version,s.all([l.getController(),p.getMetadata(e.cpAssetId),h.getMetadata(i.assetId)]).then((function(o){var a=o[0],u=o[1],c=o[2];return s.all([p.updateMetadata(e.cpAssetId,{custom:t.extend(u.custom||{},{brandedChromeAssetId:i.assetId})}),n.composite.pull().then((function(){return a.setActiveContext(n,r,!0)})).then((function(){return a.setLastPublishedContext(n,r)})),h.updateMetadata(i.assetId,{custom:t.extend(c.custom||{},f)})])})).catch((function(e){d.warn("Error while updating metadata for branded chrome: "+e.message+" "+e.stack)}))},getHrefForPublishedAsset:function(e,t){return"https://"+h.cpService+"/api/v2/"+t.community+"/assets/"+e},addMetaDataToPubInfo:function(e,i){var s=t.assign({},e.pubSettings,e.publishConfig);s.subcat=e.publishConfig.category,s.category=e.pubSettings.category;var r,n=this.getManifest(e.mrvlDoc,s,i),o={creator:e.mrvlDoc.getMyApp().getAppTypeID(),contentEtag:e.publishingEtag};if(t.isFunction(e.publishImpl.addToCustomMetaData)&&(o=t.merge(o,e.publishImpl.addToCustomMetaData(e.mrvlDoc))),o.contentEtag=t.trim(o.contentEtag,'"'),e.supportsAuthor&&e.publishConfig.showAuthor?t.isUndefined(e.fields.authorFullFieldId)?(o.author=e.publishConfig[e.fields.authorFirstFieldId],e.publishConfig[e.fields.authorLastFieldId]&&(o.author?o.author+=" "+e.publishConfig[e.fields.authorLastFieldId]:o.author=e.publishConfig[e.fields.authorLastFieldId])):o.author=e.publishConfig[e.fields.authorFullFieldId]:o.author="",e.publishConfig.showAvatar?o.authorAvatarPath=e.publishConfig.authorAvatarUrl:o.authorAvatarPath="",e.supportsCredits&&(o.credits=e.publishConfig[e.fields.creditsFieldId]),r=i?n:n.metadata,e.mainResourceName&&e.publishResources.results){var a=t.find(e.publishResources.results,(function(t){return t.name===e.mainResourceName}));a&&(r.main_resource={resource_path:e.mainResourceName,resource_version:a.version},e.lastUpdatedMainResourceVersion=a.version)}return t.isUndefined(e.publishConfig.removeBranding)||(o.removeBranding=e.publishConfig.removeBranding),r.alias=e.cpAlias,r.custom=o,t.isFunction(e.publishImpl.augmentMetaData)&&e.publishImpl.augmentMetaData(r,e.mrvlDoc),e.metadata=r,i?r:n},publishActualAsset:function(e){var t,i=s.defer(),n="https://"+h.cpService+"/api/v2/"+e.pubSettings.community+"/assets",o=this.addMetaDataToPubInfo(e),a=s.defer();return e.lastPublishAssetInfo={pubConfig:this.getCopyOfPubConfigFromPubInfo(e),promise:i.promise},t=JSON.stringify(o,null,"  "),r.ajax({type:"POST",url:n,headers:{"X-Api-Key":h.apiKey,Accept:"application/vnd.adobe.file+json","Content-Type":"application/json"},data:t,success:function(t,i,s){var r=s.getResponseHeader("Location"),n=r.split("/");e.cpAssetId=n[n.length-1],d.debug("Publish actual asset URL: "+r),e.link=h.cpLink(e.pubSettings.community,e.cpAssetId,e.metadata.alias),e.metadata.publish_url=e.link,a.resolve()},error:function(e){d.error("Error publishing asset "+e.status,e),a.reject(e)}}),a.promise.done((function(){i.resolve(e)}),(function(e){i.reject(e)})),i.promise},_forceFacebookScrapeOfUrl:function(t){var i=s.defer(),r={id:t,scrape:!0};return e.ajax({type:"POST",url:"https://graph.facebook.com/",data:r,success:function(e,t,s){i.resolve(e)},error:function(e){d.error("facebook scrape failed",{err:e,body:r}),i.reject(e)}}),i.promise},publishCompleted:function(e){if(e.publishImpl.handlePublishCompletedModerate)return e.publishImpl.handlePublishCompletedModerate(e.mrvlDoc,e.cpAlias,e.publishConfig,e.isRepublish);if(e.publishConfig.isPublic&&n.hasFeature("moderate-public-shares")){var t=s.defer(),i="https://"+h.cpService+"/api/v2/"+e.publishImpl.community+"/assets/"+e.cpAlias+"/moderate";return r.ajax({type:"POST",url:i,headers:{"X-Api-Key":h.apiKey,"Content-Type":"application/json"},success:function(e){t.resolve()},error:function(e){d.error("Error publishing moderate "+e.status,e),t.reject(e)}}).done(),t.promise}return s.resolve()},forceSocialScrapeOfUrl:function(e){if(e.noFBScrapeForRepublish||!n.hasFeature("share-can-do-facebook-scrape-for-republish"))return s();var t=e.link||this.getPublishedLink(e.mrvlDoc);return this._forceFacebookScrapeOfUrl(t)},_appShareChecks:{},userCanShare:function(e,i){var o=this._appShareChecks.role;if(!t.isUndefined(o))return s.resolve(o);var a=e.getCPCommunity();return o=this._appShareChecks[a],t.isUndefined(o)?i.getProfileIfLoggedIn().then(function(e){return e.getUserPublishMaybeBlockedBasedOnSSPRole().then(function(e){if(!e)return!1;if(!n.hasFeature("ssp-publish-check-for-provisional"))return!0;var i=this._appShareChecks.provisionalOrg;return t.isUndefined(i)?r.asyncGetUserOrgProvisional().then(function(e){return this._appShareChecks.provisionalOrg=e.provisional}.bind(this)):i}.bind(this)).then(function(t){return t?(this._appShareChecks.role=!1,this._appShareChecks.role):p.default.isSSPUser().then(function(t){if(t)return r.asyncGetSSPUserPolicyOrg().then(function(e){return e?{url:"https://"+h.cpService+"/api/v2/policy?org_id="+e}:{url:"https://"+h.cpService+"/api/v2/"+a+"/users/me/policy"}}.bind(this));var i=e.getSparkUserOrg();return i?{url:"https://"+h.cpService+"/api/v2/"+a+"/users/me/policy?orgId="+i}:{url:"https://"+h.cpService+"/api/v2/"+a+"/users/me/policy"}}.bind(this)).then(function(e){var t={Accept:"*/*","X-api-key":h.apiKey};return r.ajax({type:"GET",url:e.url,headers:t}).then(function(e,t,i){return this._appShareChecks[a]=!!e.public_share,this._appShareChecks[a]}.bind(this),(function(e){return d.error("error checking if user can share",e),s.reject(e)}))}.bind(this))}.bind(this))}.bind(this)):s.resolve(o)}})}.apply(t,s))||(e.exports=r)}}]);
//# sourceMappingURL=mui-cppublisher-a69f47aa.js.map